<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Plentify Controller">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/png" href="geyser.png">
  <link rel="apple-touch-icon" href="geyser.png">
  <link rel="manifest" href="manifest.json">
  <title>Plentify Controller</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
    }
    iframe {
      position: absolute;
      height: 100%;
      width: 100%;
      border: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(255,255,255,0.15);
      border-top-color: rgba(255,255,255,0.8);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="loader" id="loader"><div class="spinner"></div></div>
  <iframe id="app"></iframe>
  <script>
    var baseUrl = 'https://script.google.com/macros/s/AKfycbwhJSCAnwtkhGFOl-7R1SZt4aJXvCFhxoaTM1IT67arA-_spILfiTzw3_JKz4YZQXV2rA/exec';
    var iframe = document.getElementById('app');

    // If we have a saved token, pass it via URL parameter so GAS can auto-authenticate
    var savedToken = localStorage.getItem('plentify_token');
    iframe.src = savedToken ? baseUrl + '?token=' + encodeURIComponent(savedToken) : baseUrl;

    // After iframe loads, reveal it
    iframe.addEventListener('load', function() {
      document.getElementById('loader').style.display = 'none';
      iframe.style.opacity = '1';
    });

    // Listen for messages from the GAS app (via window.top.postMessage)
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'plentify_auth') {
        // New token after PIN success — store for next visit
        localStorage.setItem('plentify_token', e.data.token);
        if (e.data.user) {
          localStorage.setItem('plentify_user', e.data.user);
        }
      } else if (e.data && e.data.type === 'plentify_clear') {
        // Token expired — clear stored data
        localStorage.removeItem('plentify_token');
        localStorage.removeItem('plentify_user');
      }
    });

    // VAPID public key for push subscription
    var VAPID_PUBLIC_KEY = 'BD8gVV5o4WNMbUYGjA9HDPPNpXdIR2YmYG-dzFbZnbZ2HCq2VYWyaiVix_CXlj8sVMoTJ-D6_htGnj99OyMSGeo';

    function urlBase64ToUint8Array(base64String) {
      var padding = '='.repeat((4 - base64String.length % 4) % 4);
      var base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      var rawData = atob(base64);
      var outputArray = new Uint8Array(rawData.length);
      for (var i = 0; i < rawData.length; i++) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(function(reg) {
        var savedUser = localStorage.getItem('plentify_user');
        if (!savedUser) return;

        reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        }).then(function(sub) {
          fetch(baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
              action: 'savePushSubscription',
              user: savedUser,
              subscription: sub.toJSON()
            })
          });
        });
      });
    }
  </script>
</body>
</html>